name: Cherry-pick PR for Release Branch
on:
  push:
    branches: ['release/**']
jobs:
  Cherry-pick_PR:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
     
      - name: Check merge conflicts
        run : |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull --no-commit --no-ff origin main
  
          
      - name : Validate PR title
        if: ${{ !success() }}
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ github.event.commits[0].message }}
          regex: '^FIX+\([A-Z]+\-[0-9]+\)+\:'
   
      - run: |
          echo "${{steps.regex-match.outputs.match}}"
          echo "Well done! Your commit-message is valid."
      
      - name : Notify developer if PR title validation falied
        if: ${{ !success() && steps.regex-match.outputs.match == '' }}
        uses: neonidian/teams-notify-build-status@v3
        with:
          webhookUrl: ${{ secrets.TEAMS_INCOMING_WEBHOOK_URL }}
          message: >-
            Hi ${{github.actor}},
            We require pull request titles to follow the PR Title Conventions and it looks like your proposed title ${{github.event.commits[0].message}} needs to be adjusted.
          status: Failure


      - name: Create Cherry-pick PR
        if: ${{ startsWith(github.ref, 'refs/heads/release') && success() &&  steps.regex-match.outputs.match != '' }}
        uses: devops-infra/action-pull-request@v0.5.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          title: ${{ github.event.commits[0].message }}
          assignee: ${{ github.actor }}
          label: hot-fix
          new_string: ${{ github.event.commits[0].message }}
          target_branch : 'main'
          source_branch : ${{ github.head_ref || github.ref_name }} 